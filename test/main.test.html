<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>
<body>
  <canvas id="canvas" width="400" height="400"></canvas>
  <script>
    class Node {
      constructor(element, left=null, right=null, parent=null) {
        this.element = element
        this.left = left
        this.right = right
        this.parent = parent
      }
    }
    const root = new Node(1)
    root.left = new Node(2)
    root.right = new Node(3)
    const t1 = root.left.left = new Node(4)
    const t2 = root.left.right = new Node(5)
    root.right.left = new Node(6)
    root.right.right = new Node(7)

    t1.left = new Node(8)
    t1.right = new Node(9)
    t2.left = new Node(10)
    t2.right = new Node(11)
    const tree = {
      root
    }

    function roundedRect(ctx, x, y, width, height, radius){
      ctx.beginPath();
      ctx.moveTo(x, y + radius);
      ctx.lineTo(x, y + height - radius);
      ctx.quadraticCurveTo(x, y + height, x + radius, y + height);
      ctx.lineTo(x + width - radius, y + height);
      ctx.quadraticCurveTo(x + width, y + height, x + width, y + height - radius);
      ctx.lineTo(x + width, y + radius);
      ctx.quadraticCurveTo(x + width, y, x + width - radius, y);
      ctx.lineTo(x + radius, y);
      ctx.quadraticCurveTo(x, y, x, y + radius);
      ctx.fill();
    }
  </script>
  <script>
    let lineColor = 'rgb(66,66,66)'
    let rectColor = 'rgb(249, 38, 114)'
    let fontColor = '#fff'
    let rectHeight = 30
    let points = []
    let rectPadding = 20

    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    canvas.width = 500

    function draw() {
      ctx.font = 'bold 16px Consolas'
      ctx.textAlign = 'center'
      let startPoint = [canvas.width >> 1, 30]
      drawNode(tree.root, ...startPoint)
    }
    draw()

    function overlap(ctx, x, y, w) {
      const { e, f } = ctx.getTransform()
      x += e
      y += f
      let distance = 0
      let isChongdie = points.some(([pointL, pointR, pointY]) => {
        distance = pointR - x
        return !(pointY !== y || x > pointR || x + w < pointL)
      })
      if (isChongdie) {
        return distance
      }
      return 0
    }

    function drawNode(node, x, y) {
      const content = node.element.toString()
      const text = ctx.measureText(content)
      const rectWidth = getWidth(text)
      ctx.save()
      ctx.translate(x, y)
      const { e, f } = ctx.getTransform()
      points.push([e, e + rectWidth, f])
      // 1. 最外层
      ctx.fillStyle = lineColor
      ctx.fillRect(0, 0, rectWidth, rectHeight)

      // 2. 红色层
      ctx.fillStyle = rectColor
      ctx.fillRect(2, 2, rectWidth - 4, rectHeight - 4)

      // 3. 内容
      ctx.fillStyle = fontColor
      ctx.fillText(content, rectWidth >> 1, (rectHeight >> 1) + 6)

      drawLeft(node.left, 0, rectHeight >> 1)
      drawRight(node.right, rectWidth, rectHeight >> 1)
      ctx.restore()
    }

    function drawLeft(left, x, y) {
      if (left === null) return
      var content = left.element.toString()
      var text = ctx.measureText(content)
      const currentRectWidth = getWidth(text)
      const leftRectWidth = currentRectWidth // getLineWidth(left)
      let destX = x - (leftRectWidth)
      let destY = y + rectHeight
      let newNodePoint = [destX - (currentRectWidth >> 1), destY]
      const chongdieDistance = overlap(
        ctx, newNodePoint[0], newNodePoint[1], currentRectWidth
      )
      if (chongdieDistance > 0) {
        destX = destX + 15
        newNodePoint = [destX - (currentRectWidth >> 1), destY]
        lineColor = 'rgba(66,66,66,.5)'
        rectColor = 'rgba(249, 38, 114,.5)'
      } else {
        lineColor = 'rgba(66,66,66,1)'
        rectColor = 'rgba(249, 38, 114,1)'
      }
      ctx.beginPath();
      ctx.moveTo(x, y)
      ctx.lineTo(destX, y)
      ctx.lineTo(destX, destY)
      ctx.lineTo(destX - 5, destY - 5)
      ctx.lineTo(destX, destY)
      ctx.lineTo(destX + 5, destY - 5)
      ctx.save()
      ctx.strokeStyle = lineColor
      ctx.lineWidth = 2
      ctx.stroke()
      ctx.restore()
      ctx.closePath()
      drawNode(left, newNodePoint[0], newNodePoint[1])
    }
    function drawRight(right, x, y) {
      if (right === null) return
      var content = right.element.toString()
      var text = ctx.measureText(content)
      const currentRectWidth = getWidth(text)
      const rightRectWidth = currentRectWidth // getLineWidth(right)
      let destX = x + (rightRectWidth)
      let destY = y + rectHeight
      let newNodePoint = [destX - (currentRectWidth >> 1), destY]
      const chongdieDistance = overlap(
        ctx, newNodePoint[0], newNodePoint[1], currentRectWidth
      )
      if (chongdieDistance > 0) {
        destX = destX + 15
        newNodePoint = [destX - (currentRectWidth >> 1), destY]
        lineColor = 'rgba(66,66,66,.5)'
        rectColor = 'rgba(249, 38, 114,.5)'
      } else {
        lineColor = 'rgba(66,66,66,1)'
        rectColor = 'rgba(249, 38, 114,1)'
      }
      ctx.beginPath();
      ctx.moveTo(x, y)
      ctx.lineTo(destX, y)
      ctx.lineTo(destX, destY)
      ctx.lineTo(destX - 5, destY - 5)
      ctx.lineTo(destX, destY)
      ctx.lineTo(destX + 5, destY - 5)
      ctx.save()
      ctx.strokeStyle = lineColor
      ctx.lineWidth = 2
      ctx.stroke()
      ctx.restore()
      ctx.closePath()
      drawNode(right, newNodePoint[0], newNodePoint[1])
    }

    function getLineWidth(node) {
      let width = 0
      if (node) {
        let content = node.element.toString()
        let text = ctx.measureText(content)
        width += getWidth(text)
        width += getLineWidth(node.left)
        width += getLineWidth(node.right)
      }
      return width
    }

    function getWidth(text, padding = 20, mini = 50) {
      return Math.max(text.width + padding, mini)
    }
    // drawNode(tree.root)
  </script>
</body>
</html>